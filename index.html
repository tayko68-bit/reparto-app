// =================================================================
// CONFIGURACIÓN INICIAL
// =================================================================
const ss = SpreadsheetApp.getActiveSpreadsheet();
const controlSheet = ss.getSheetByName("Control de Pedidos");
const padronSheet = ss.getSheetByName("Padrón de Clientes");
const bitacoraSheet = ss.getSheetByName("Bitácora de Escaneos");

// =================================================================
// FUNCIÓN PRINCIPAL - doGet
// =================================================================
function doGet(e) {
  try {
    const data = JSON.parse(e.parameter.data);
    let resultado;

    switch (data.accion) {
      case 'consultar_factura':
        resultado = consultarFactura(data);
        break;
      case 'registrar_factura':
        resultado = registrarNuevaFactura(data);
        break;
      case 'actualizar_status':
        resultado = actualizarStatusPedido(data);
        break;
      default:
        throw new Error("Acción no reconocida.");
    }
    return ContentService
      .createTextOutput(JSON.stringify({ status: "success", data: resultado }))
      .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService
      .createTextOutput(JSON.stringify({ status: "error", message: error.message }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// =================================================================
// LÓGICA DE NEGOCIO
// =================================================================

// NUEVA FUNCIÓN: Consulta el estado y los datos de una factura
function consultarFactura(data) {
  const { idPedido } = data;
  const fila = findRowById(idPedido);
  
  // Si no encuentra la factura en "Control de Pedidos", busca al cliente en el Padrón
  if (fila === -1) {
    const { rfc } = data;
    if (!rfc) throw new Error("Factura no registrada y no se proporcionó RFC.");
    const clienteInfo = findClientByRfc(rfc);
    // Devuelve la información del cliente con un status "NO_REGISTRADO"
    return { status: "NO_REGISTRADO", cliente: clienteInfo };
  }

  // Si la encuentra, devuelve todos los datos de esa fila
  const headers = controlSheet.getRange(1, 1, 1, controlSheet.getLastColumn()).getValues()[0];
  const rowData = controlSheet.getRange(fila, 1, 1, controlSheet.getLastColumn()).getValues()[0];
  let pedidoInfo = {};
  headers.forEach((header, index) => {
    pedidoInfo[header] = rowData[index];
  });
  return { status: "REGISTRADO", pedido: pedidoInfo };
}

function registrarNuevaFactura(data) {
  const { idPedido, numeroPedidoOrigen, rfc, surtidor } = data;
  if (findRowById(idPedido) !== -1) {
    throw new Error(`Esta factura ya fue registrada.`);
  }
  const clienteInfo = findClientByRfc(rfc);
  const nuevaFila = [
    idPedido, numeroPedidoOrigen, "Facturado", // Status inicial
    clienteInfo['Razón Social'], rfc, surtidor, new Date(), "", "", "", ""
  ];
  controlSheet.appendRow(nuevaFila);
  bitacoraSheet.appendRow([new Date(), idPedido, "Facturado", surtidor]);
  return `Factura registrada para: ${clienteInfo['Razón Social']}.`;
}

function actualizarStatusPedido(data) {
  const { idPedido, nuevoStatus, usuario, detalles } = data;
  const fila = findRowById(idPedido);
  if (fila === -1) throw new Error(`Pedido ${idPedido} no encontrado.`);

  controlSheet.getRange(fila, 3).setValue(nuevoStatus); // Columna C: Status
  
  let timestampCol;
  switch (nuevoStatus) {
    case "En Ruta": timestampCol = 8; break; // Col H
    case "En Proceso de Entrega": timestampCol = 8; break; // Sobreescribimos la misma para saber la última acción en ruta
    case "Entregado": timestampCol = 9; break; // Col I
    case "Entrega Fallida": timestampCol = 9; break; // Col I
  }
  if (timestampCol) controlSheet.getRange(fila, timestampCol).setValue(new Date());

  // Si hay detalles (motivo de fallo, link a firma, etc.) los podemos guardar
  // Por ahora, solo registramos en bitácora
  bitacoraSheet.appendRow([new Date(), idPedido, nuevoStatus, usuario, detalles || ""]);
  return `Pedido ${idPedido} actualizado a: ${nuevoStatus}.`;
}

// =================================================================
// FUNCIONES DE AYUDA (ACTUALIZADAS)
// =================================================================
function findRowById(id) {
  const data = controlSheet.getRange("A:A").getValues();
  for (let i = 0; i < data.length; i++) {
    if (data[i][0] == id) return i + 1;
  }
  return -1;
}

function findClientByRfc(rfc) {
  if (!rfc || rfc === "SIN_RFC") return { 'Razón Social': 'CLIENTE SIN RFC', 'RFC': 'N/A' };
  const headers = padronSheet.getRange(1, 1, 1, padronSheet.getLastColumn()).getValues()[0];
  const rfcColumnIndex = headers.indexOf('RFC');
  if (rfcColumnIndex === -1) throw new Error("Columna 'RFC' no encontrada en Padrón.");
  
  const allData = padronSheet.getDataRange().getValues();
  // Empezamos en 1 para saltar la cabecera
  for (let i = 1; i < allData.length; i++) {
    if (allData[i][rfcColumnIndex].toString().trim().toUpperCase() === rfc.toString().trim().toUpperCase()) {
      let clientInfo = {};
      headers.forEach((header, index) => { clientInfo[header] = allData[i][index]; });
      return clientInfo;
    }
  }
  return { 'Razón Social': 'CLIENTE NO ENCONTRADO EN PADRÓN', 'RFC': rfc };
}
