<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Trazabilidad</title>
    <style>
        :root {
            --main-bg-color: #f4f7f6; --card-bg-color: #ffffff; --primary-color: #007bff;
            --secondary-color: #6c757d; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --orange-color: #fd7e14;
            --text-color: #333; --text-light-color: #555; --border-color: #e0e0e0;
        }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 10px; background-color: var(--main-bg-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; }
        .vista { background: var(--card-bg-color); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        h1, h2 { text-align: center; border-bottom: 2px solid var(--border-color); padding-bottom: 15px; margin-top: 0; color: var(--text-color); }
        button { display: block; width: 100%; padding: 16px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; transition: all 0.3s ease; text-align: center; }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn-main { background-color: var(--primary-color); } .btn-secondary { background-color: var(--secondary-color); }
        .btn-confirm { background-color: var(--success-color); } .btn-cancel { background-color: var(--danger-color); }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--text-color); }
        input, select, textarea { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 8px; border: 2px solid var(--border-color); font-size: 16px; background-color: #fcfcfc; transition: border-color 0.3s ease; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); }
        textarea { resize: vertical; min-height: 80px; }
        .status-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; max-width: 90%; width: auto; min-width: 320px; text-align: center; font-weight: bold; padding: 20px 25px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.3); transition: all 0.3s ease; backdrop-filter: blur(5px); }
        .status-success { background-color: rgba(212, 237, 218, 0.95); color: #155724; border: 2px solid #c3e6cb; }
        .status-error { background-color: rgba(248, 215, 218, 0.95); color: #721c24; border: 2px solid #f5c6cb; }
        .status-loading { background-color: rgba(209, 236, 241, 0.95); color: #0c5460; border: 2px solid #bee5eb; }
        .info-card, .entrega-item { background-color: #f8f9fa; border: 1px solid var(--border-color); padding: 15px; border-radius: 8px; margin-bottom: 10px; }
        .info-card h3 { margin-top: 0; text-align: center; color: var(--primary-color); font-size: 1.3em; }
        .info-card p, .entrega-item p { margin: 8px 0; font-size: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; word-wrap: break-word; }
        .info-card p:last-child, .entrega-item p:last-child { border-bottom: none; padding-bottom: 0; }
        .info-card p strong, .entrega-item p strong { color: var(--text-color); display: inline-block; min-width: 120px; }
        .status-tag { padding: 5px 10px; border-radius: 15px; color: white; font-weight: bold; display: inline-block; font-size: 14px; float: right; }
        .status-Facturado { background-color: var(--warning-color); color: #333; } .status-En\.Ruta { background-color: var(--info-color); }
        .status-En\.Proceso\.de\.Entrega { background-color: var(--orange-color); }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .descripcion { text-align: center; color: var(--text-light-color); margin-bottom: 20px; font-style: italic; }
        .captura-container { margin: 20px 0; padding: 15px; border: 2px dashed var(--border-color); border-radius: 8px; text-align: center; }
        .firma-canvas { border: 2px solid var(--border-color); border-radius: 8px; width: 100%; height: 200px; cursor: crosshair; background-color: white; }
        .firma-container { margin: 20px 0; }
        .canvas-controls { display: flex; gap: 10px; margin-top: 10px; }
        .canvas-controls button { flex: 1; margin: 0; padding: 10px; font-size: 14px; }
        #lector-container, #camara-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        #camara-video, #lector-qr { width: 100%; max-width: 480px; height: auto; border-radius: 12px; border: 3px solid white; }
        .scanner-header, .camara-header { color: white; text-align: center; margin-bottom: 15px; }
        .scanner-header h3, .camara-header h3 { margin: 0 0 10px 0; font-size: 1.4em; }
        .close-scanner, .close-camara, .capture-photo { background-color: var(--danger-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin: 8px; min-width: 120px; }
        .capture-photo { background-color: var(--success-color); }
        .camera-controls { display: flex; gap: 15px; margin-top: 15px; }
        #galeria-fotos { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center; }
        .miniatura-container { position: relative; }
        .miniatura { width: 80px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border-color); }
        .btn-eliminar-foto { position: absolute; top: -5px; right: -5px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 24px; height: 24px; padding: 0; font-size: 14px; line-height: 24px; text-align: center; cursor: pointer; border: 2px solid white; margin: 0; }
    </style>
</head>
<body>
    <div class="container">
        <div id="vista-principal" class="vista">
            <h1>üöõ Sistema de Trazabilidad</h1>
            <p class="descripcion">Selecciona el m√≥dulo:</p>
            <button type="button" id="btn-rol-almacen" class="btn-main">üì¶ Almac√©n</button>
            <button type="button" id="btn-rol-repartidor" class="btn-secondary">üöö Reparto</button>
        </div>

        <div id="vista-almacen-form" class="vista hidden">
            <h2>üì¶ M√≥dulo de Almac√©n</h2>
            <label for="numero-pedido">N¬∫ Pedido Original:</label>
            <input type="text" id="numero-pedido" required>
            <label for="nombre-usuario-almacen">Tu Nombre (Surtidor):</label>
            <input type="text" id="nombre-usuario-almacen" required>
            <button type="button" id="btn-escanear-factura" class="btn-main">üì∏ Escanear QR</button>
            <button type="button" class="btn-secondary btn-volver">‚Üê Volver</button>
        </div>

        <div id="vista-repartidor-form" class="vista hidden">
            <h2>üöö M√≥dulo de Reparto</h2>
            <label for="nombre-repartidor">Tu Nombre (Repartidor):</label>
            <input type="text" id="nombre-repartidor" required>
            <button type="button" id="btn-escanear-repartidor" class="btn-main">üì∏ Escanear QR de una factura</button>
            <button type="button" id="btn-ver-lista" class="btn-secondary" style="background-color: var(--info-color);">üóíÔ∏è Ver mis entregas de hoy</button>
            <button type="button" class="btn-secondary btn-volver">‚Üê Volver al Inicio</button>
        </div>

        <div id="vista-lista-reparto" class="vista hidden">
            <h2>üóíÔ∏è Mis Entregas Pendientes</h2>
            <div id="lista-entregas-container"></div>
            <button type="button" class="btn-secondary btn-volver">‚Üê Volver a Reparto</button>
        </div>

        <div id="vista-accion" class="vista hidden">
            <h2 id="accion-titulo"></h2>
            <div class="info-card">
                <h3 id="accion-cliente"></h3>
                <p><strong>N¬∫ Pedido:</strong> <span id="accion-pedido-origen"></span></p>
                <p><strong>N¬∫ Factura:</strong> <span id="accion-numero-factura"></span></p>
                <p><strong>Status:</strong> <span id="accion-status" class="status-tag"></span></p>
            </div>
            <div id="acciones-botones"></div>
            <button type="button" class="btn-cancel btn-volver">‚ùå Cancelar</button>
        </div>
        
        <div id="vista-captura-entrega" class="vista hidden">
            <h2>üì∏ Documentar Entrega</h2>
            <div class="captura-container">
                <h4>üìÑ Evidencias (Factura, Cajas, etc.)</h4>
                <button type="button" id="btn-capturar-foto" class="btn-secondary">üì∏ A√±adir Foto</button>
                <div id="galeria-fotos"></div>
            </div>
            <label for="info-adicional">üìù Informaci√≥n Adicional</label>
            <textarea id="info-adicional" placeholder="Ej: Recibi√≥ Juan P√©rez..."></textarea>
            <div class="firma-container">
                <label>‚úçÔ∏è Firma del Cliente (Opcional)</label>
                <canvas id="firma-canvas" class="firma-canvas"></canvas>
                <div class="canvas-controls">
                    <button type="button" id="btn-limpiar-firma" class="btn-secondary">üóëÔ∏è Limpiar Firma</button>
                </div>
            </div>
            <button type="button" id="btn-confirmar-entrega-completa" class="btn-confirm">‚úÖ Confirmar Entrega</button>
            <button type="button" class="btn-cancel btn-volver">‚ùå Cancelar</button>
        </div>

        <div id="vista-repartidor-fallo" class="vista hidden">
            <h2>‚ùå Reportar Entrega Fallida</h2>
            <label for="motivo-fallo">Motivo:</label>
            <select id="motivo-fallo" required>
                <option value="">-- Selecciona motivo --</option>
                <option value="Cliente no estaba">Cliente no estaba</option>
                <option value="Pedido rechazado">Pedido rechazado</option>
                <option value="Direcci√≥n incorrecta">Direcci√≥n incorrecta</option>
                <option value="Otro">Otro</option>
            </select>
            <button type="button" id="btn-confirmar-fallo" class="btn-confirm">‚úÖ Confirmar Fallo</button>
            <button type="button" class="btn-cancel btn-volver">‚ùå Cancelar</button>
        </div>

        <div id="lector-container" class="hidden">
            <div class="scanner-header"><h3>üì∏ Escanear QR</h3></div>
            <video id="lector-qr" autoplay muted playsinline></video>
            <button type="button" class="close-scanner">‚ùå Cerrar</button>
        </div>
        <div id="camara-container" class="hidden">
            <div class="camara-header"><h3>üì∏ Capturar Evidencia</h3></div>
            <video id="camara-video" autoplay muted playsinline></video>
            <div class="camera-controls">
                <button type="button" class="capture-photo">üì∏ Tomar Foto</button>
                <button type="button" class="close-camara">‚ùå Cancelar</button>
            </div>
        </div>

    </div>

    <div class="status-message hidden" id="status-message"></div>
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
    <script>
        class SistemaTrazabilidad {
            constructor() {
                this.SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzL_F_ry-QPBWYMfwoG6kX8ROqUSPYiLnPX05gLa6nvMPShefhxU38n3Fb6f4Yxl2vEiQ/exec";
                this.estado = {
                    modulo: null, scanner: null, cameraStream: null, datosPendientes: {},
                    procesandoAccion: false, fotosEvidencia: [], firmaCliente: null,
                    clienteInfo: null, pedidoInfo: null
                };
                this.inicializar();
            }

            inicializar() {
                this.bindearEventos();
                this.inicializarFirma();
            }

            bindearEventos() {
                document.getElementById('btn-rol-almacen').addEventListener('click', () => { this.estado.modulo = 'almacen'; this.cambiarVista('almacen-form'); });
                document.getElementById('btn-rol-repartidor').addEventListener('click', () => { this.estado.modulo = 'repartidor'; this.cambiarVista('repartidor-form'); });
                document.getElementById('btn-escanear-factura').addEventListener('click', () => this.validarFormularioAlmacen() && this.iniciarScanner());
                document.getElementById('btn-escanear-repartidor').addEventListener('click', () => this.validarFormularioRepartidor() && this.iniciarScanner());
                document.getElementById('btn-ver-lista').addEventListener('click', () => this.mostrarListaReparto());
                document.querySelector('.close-scanner').addEventListener('click', () => this.detenerScanner());
                document.querySelector('.close-camara').addEventListener('click', () => this.detenerCamara());
                document.querySelector('.capture-photo').addEventListener('click', () => this.capturarFoto());
                document.getElementById('btn-capturar-foto').addEventListener('click', () => this.iniciarCapturarFactura());
                document.getElementById('btn-limpiar-firma').addEventListener('click', () => this.limpiarFirma());
                document.getElementById('btn-confirmar-entrega-completa').addEventListener('click', () => this.confirmarEntregaCompleta());
                document.getElementById('btn-confirmar-fallo').addEventListener('click', () => this.confirmarFallo());

                document.querySelectorAll('.btn-volver').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const vistaActual = e.target.closest('.vista').id;
                        if (vistaActual === 'vista-lista-reparto') {
                            this.cambiarVista('repartidor-form');
                        } else {
                            this.volverAlInicio();
                        }
                    });
                });
            }
            
            // ... (El resto de las funciones JS van aqu√≠, sin cambios respecto a la √∫ltima versi√≥n funcional) ...
            inicializarFirma(){const t=document.getElementById("firma-canvas"),e=t.getContext("2d");let n=!1;const i=()=>{const o=t.getBoundingClientRect();t.width=o.width,t.height=o.height,e.strokeStyle="#000",e.lineWidth=2,e.lineCap="round"};i(),window.addEventListener("resize",i);const o=n=>{const i=t.getBoundingClientRect(),o=n.touches?n.touches[0]:n;return{x:o.clientX-i.left,y:o.clientY-i.top}},s=t=>{t.preventDefault(),n=!0;const{x:i,y:s}=o(t);e.beginPath(),e.moveTo(i,s)},a=t=>{n&&(t.preventDefault(),(() => {const{x:n,y:i}=o(t);e.lineTo(n,i),e.stroke()})())},r=t=>{n&&(t.preventDefault(),n=!1)};t.addEventListener("mousedown",s),t.addEventListener("mousemove",a),t.addEventListener("mouseup",r),t.addEventListener("mouseleave",r),t.addEventListener("touchstart",s,{passive:!1}),t.addEventListener("touchmove",a,{passive:!1}),t.addEventListener("touchend",r,{passive:!1})}
            cambiarVista(t){document.querySelectorAll(".vista, #lector-container, #camara-container").forEach(t=>{t.classList.add("hidden")});const e=document.getElementById(`vista-${t}`)||document.getElementById(`${t}-container`);e&&e.classList.remove("hidden"),this.limpiarMensaje()}
            validarFormularioAlmacen(){const t=document.getElementById("numero-pedido").value.trim(),e=document.getElementById("nombre-usuario-almacen").value.trim();return!t||!e?(this.mostrarMensaje("Por favor, completa todos los campos","error"),!1):!0}
            validarFormularioRepartidor(){const t=document.getElementById("nombre-repartidor").value.trim();return t? !0:(this.mostrarMensaje("Por favor, ingresa tu nombre","error"),!1)}
            async iniciarScanner(){try{this.cambiarVista("lector"),this.mostrarMensaje("Iniciando c√°mara...","loading");const t=document.getElementById("lector-qr");this.estado.scanner=new QrScanner(t,t=>this.onScanSuccess(t.data),{preferredCamera:"environment",highlightScanRegion:!0}),await this.estado.scanner.start(),this.limpiarMensaje()}catch(t){this.mostrarMensaje(`Error al acceder a la c√°mara: ${t.message}`,"error"),this.volverAlInicio()}}
            detenerScanner(){this.estado.scanner&&(this.estado.scanner.stop(),this.estado.scanner.destroy(),this.estado.scanner=null);const t="almacen"===this.estado.modulo?"almacen-form":"repartidor-form";this.cambiarVista(t)}
            async iniciarCapturarFactura(){try{this.cambiarVista("camara"),this.mostrarMensaje("Iniciando c√°mara...","loading");const t=document.getElementById("camara-video"),e={video:{facingMode:"environment"}};this.estado.cameraStream=await navigator.mediaDevices.getUserMedia(e),t.srcObject=this.estado.cameraStream,await t.play(),this.limpiarMensaje()}catch(t){this.mostrarMensaje(`Error al acceder a la c√°mara: ${t.message}`,"error"),this.cambiarVista("captura-entrega")}}
            capturarFoto(){const t=document.getElementById("camara-video");if(!t.srcObject||0===t.videoWidth)return void this.mostrarMensaje("La c√°mara no est√° lista.","error");const e=document.createElement("canvas"),n=e.getContext("2d");t.videoWidth>t.videoHeight?(e.width=t.videoHeight,e.height=t.videoWidth,n.translate(t.videoHeight,0),n.rotate(Math.PI/2)):(e.width=t.videoWidth,e.height=t.videoHeight),n.drawImage(t,0,0,t.videoWidth,t.videoHeight);const i=e.toDataURL("image/jpeg",.6);this.estado.fotosEvidencia.push(i),this.renderizarGaleria(),this.detenerCamara(),this.mostrarMensaje("‚úÖ Foto a√±adida","success")}
            renderizarGaleria(){const t=document.getElementById("galeria-fotos");t.innerHTML="",this.estado.fotosEvidencia.forEach((e,n)=>{const i=document.createElement("div");i.className="miniatura-container";const o=document.createElement("img");o.src=e,o.className="miniatura";const s=document.createElement("button");s.className="btn-eliminar-foto",s.innerHTML="√ó",s.onclick=()=>{this.estado.fotosEvidencia.splice(n,1),this.renderizarGaleria()},i.appendChild(o),i.appendChild(s),t.appendChild(i)})}
            detenerCamara(){this.estado.cameraStream&&(this.estado.cameraStream.getTracks().forEach(t=>{t.stop()}),this.estado.cameraStream=null),this.cambiarVista("captura-entrega")}
            limpiarFirma(){const t=document.getElementById("firma-canvas");t.getContext("2d").clearRect(0,0,t.width,t.height),this.estado.firmaCliente=null}
            guardarFirma(){const t=document.getElementById("firma-canvas").getContext("2d").getImageData(0,0,document.getElementById("firma-canvas").width,document.getElementById("firma-canvas").height);t.data.some(t=>0!==t)?this.estado.firmaCliente=document.getElementById("firma-canvas").toDataURL("image/png"):this.estado.firmaCliente=null}
            async confirmarEntregaCompleta(){if(this.estado.procesandoAccion)return;try{this.estado.procesandoAccion=!0;const t=document.getElementById("btn-confirmar-entrega-completa");t.disabled=!0,t.innerHTML='<span class="loading-spinner"></span>Procesando...',this.guardarFirma();const e={accion:"registrar_entrega_con_evidencias",idPedido:this.estado.datosPendientes.idPedido,usuario:this.estado.datosPendientes.usuario,ubicacion:this.estado.datosPendientes.ubicacion,detalles:document.getElementById("info-adicional").value.trim(),fotosEvidenciaBase64:this.estado.fotosEvidencia,firmaClienteBase64:this.estado.firmaCliente};await this.enviarDatosPOST(e),this.mostrarMensaje("‚úÖ Entrega registrada y notificaciones enviadas.","success"),setTimeout(()=>this.volverAlInicio(),3e3)}catch(t){this.mostrarMensaje(`Error: ${t.message}`,"error")}finally{this.estado.procesandoAccion=!1;const t=document.getElementById("btn-confirmar-entrega-completa");t&&(t.disabled=!1,t.innerHTML="‚úÖ Confirmar Entrega")}}
            async onScanSuccess(t){if(this.estado.procesandoAccion)return;try{this.estado.procesandoAccion=!0,this.detenerScanner(),this.mostrarMensaje("Procesando QR...","loading");const e=this.validarQR(t),n=await this.obtenerUbicacion();if(this.estado.datosPendientes={idPedido:e.id,rfc:e.rfc||"SIN_RFC",ubicacion:n},"almacen"===this.estado.modulo){this.mostrarMensaje("Verificando factura...","loading");const t=await this.enviarDatos({accion:"consultar_factura",idPedido:e.id});"REGISTRADO"===t.status?(this.mostrarMensaje("‚ö†Ô∏è Esta factura ya fue registrada anteriormente.","error"),setTimeout(()=>this.volverAlInicio(),4e3)):(this.mostrarMensaje("Factura nueva, registrando...","loading"),this.estado.datosPendientes.usuario=document.getElementById("nombre-usuario-almacen").value.trim(),this.estado.datosPendientes.numeroPedidoOrigen=document.getElementById("numero-pedido").value.trim(),await this.enviarDatosPOST({accion:"registrar_factura",...this.estado.datosPendientes}),this.mostrarMensaje("Factura registrada con √©xito.","success"),setTimeout(()=>this.volverAlInicio(),3e3))}else{this.estado.datosPendientes.usuario=document.getElementById("nombre-repartidor").value.trim();const t=await this.enviarDatos({accion:"consultar_factura",idPedido:e.id});this.manejarRespuestaConsulta(t)}}catch(t){this.mostrarMensaje(`Error: ${t.message}`,"error"),setTimeout(()=>this.volverAlInicio(),3e3)}finally{this.estado.procesandoAccion=!1}}
            validarQR(t){try{const e=new URL(t),n=e.searchParams.get("id");if(!n||!/^[A-Za-z0-9\-_]+$/.test(n))throw new Error;return{id:n,rfc:e.searchParams.get("rr")}}catch(t){throw new Error("C√≥digo QR no v√°lido")}}
            obtenerUbicacion(){return new Promise(t=>{if(!navigator.geolocation)return void t("Geolocalizaci√≥n no soportada");const e=setTimeout(()=>t("Timeout de geolocalizaci√≥n"),8e3);navigator.geolocation.getCurrentPosition(n=>{clearTimeout(e),t(`${n.coords.latitude},${n.coords.longitude}`)},n=>{clearTimeout(e),t(`Error: ${n.message}`)},{timeout:8e3,enableHighAccuracy:!1})})}
            manejarRespuestaConsulta(t){"REGISTRADO"===t.status?this.mostrarFichaDeAccion(t.pedido):(this.mostrarMensaje("Factura no encontrada.","error"),setTimeout(()=>this.volverAlInicio(),3e3))}
            mostrarFichaDeAccion(t){document.getElementById("accion-titulo").textContent="Siguiente Acci√≥n",document.getElementById("accion-cliente").textContent=t.Raz√≥n_Social||"N/A",document.getElementById("accion-pedido-origen").textContent=t.Numero_Pedido_Origen||"N/A",document.getElementById("accion-numero-factura").textContent=t.ID_Pedido||"N/A";const e=t.Status_Actual||"Desconocido",n=document.getElementById("accion-status");n.textContent=e,n.className="status-tag status-"+e.replace(/\s+/g,"\\."),this.generarBotonesAccion(e),this.cambiarVista("accion")}
            generarBotonesAccion(t){const e=document.getElementById("acciones-botones");e.innerHTML="";const n={Facturado:{texto:"üöö Iniciar Ruta",clase:"btn-main",accion:()=>this.actualizarStatus("En Ruta")},"En Almac√©n (Devoluci√≥n)":{texto:"üöö Reiniciar Ruta",clase:"btn-main",accion:()=>this.actualizarStatus("En Ruta")},"En Ruta":{texto:"üìç Marcar Pr√≥xima Entrega",clase:"btn-main",accion:()=>this.actualizarStatus("En Proceso de Entrega")},"En Proceso de Entrega":[{texto:"‚úÖ Entrega Exitosa",clase:"btn-confirm",accion:()=>this.prepararEntregaExitosa()},{texto:"‚ùå Entrega Fallida",clase:"btn-cancel",accion:()=>this.cambiarVista("repartidor-fallo")}]},i=n[t];i?(Array.isArray(i)?i:[i]).forEach(t=>{const n=document.createElement("button");n.className=t.clase,n.textContent=t.texto,n.addEventListener("click",t.accion),e.appendChild(n)}):e.innerHTML=`<p style="text-align: center; color: #666;">Este pedido ya fue procesado (${t}).</p>`}
            prepararEntregaExitosa(){this.estado.fotosEvidencia=[],this.estado.firmaCliente=null,this.renderizarGaleria(),document.getElementById("info-adicional").value="",this.limpiarFirma(),this.cambiarVista("captura-entrega")}
            async actualizarStatus(t,e=""){if(this.estado.procesandoAccion)return;try{this.estado.procesandoAccion=!0,this.mostrarMensaje(`Actualizando a: ${t}...`,"loading");const n={accion:"actualizar_status",idPedido:this.estado.datosPendientes.idPedido,nuevoStatus:t,usuario:this.estado.datosPendientes.usuario,ubicacion:this.estado.datosPendientes.ubicacion,detalles:e};await this.enviarDatosPOST(n),this.mostrarMensaje(`Estado actualizado a ${t}.`,"success"),setTimeout(()=>this.volverAlInicio(),4e3)}catch(t){this.mostrarMensaje(`Error: ${t.message}`,"error")}finally{this.estado.procesandoAccion=!1}}
            confirmarFallo(){const t=document.getElementById("motivo-fallo").value;t?this.actualizarStatus("Entrega Fallida",t):this.mostrarMensaje("Selecciona un motivo","error")}
            async enviarDatosPOST(t){try{return await fetch(this.SCRIPT_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"text/plain;charset=utf-8"},body:JSON.stringify(t)}),{mensaje:"Acci√≥n procesada."}}catch(t){throw new Error("Error de conexi√≥n.")}}
            async enviarDatos(t){return new Promise((e,n)=>{const i="c"+Date.now(),o=document.createElement("script"),s=setTimeout(()=>{delete window[i],o.parentNode&&o.remove(),n(new Error("Timeout"))},2e4);window[i]=t=>{clearTimeout(s),delete window[i],o.parentNode&&o.remove(),"success"===t.status?e(t.data):n(new Error(t.message))};const a=new URL(this.SCRIPT_URL);a.searchParams.append("data",JSON.stringify(t)),a.searchParams.append("callback",i),o.src=a.href,o.onerror=()=>{clearTimeout(s),delete window[i],o.parentNode&&o.remove(),n(new Error("Error de red."))},document.body.appendChild(o)})}
            mostrarMensaje(t,e=""){const n=document.getElementById("status-message");n.textContent=t,n.className=`status-message status-${e}`,n.classList.remove("hidden"),"success"!==e&&"error"!==e||setTimeout(()=>this.limpiarMensaje(),5e3)}
            limpiarMensaje(){const t=document.getElementById("status-message");t&&t.classList.add("hidden")}
            volverAlInicio(){this.estado.scanner&&this.detenerScanner(),this.estado.cameraStream&&this.detenerCamara(),["numero-pedido","nombre-usuario-almacen","nombre-repartidor","motivo-fallo","info-adicional"].forEach(t=>{const e=document.getElementById(t);e&&(e.value="")}),this.estado.fotosEvidencia=[],this.renderizarGaleria(),this.estado={...this.estado,modulo:null,datosPendientes:{},procesandoAccion:!1,fotosEvidencia:[],firmaCliente:null,clienteInfo:null,pedidoInfo:null},this.cambiarVista("principal")}
            async mostrarListaReparto(){const t=document.getElementById("nombre-repartidor").value.trim();if(!t)return void this.mostrarMensaje("Ingresa tu nombre para ver tu lista.","error");this.mostrarMensaje("Buscando tus entregas...","loading"),this.cambiarVista("lista-reparto");const e=document.getElementById("lista-entregas-container");e.innerHTML='<div class="loading-spinner"></div>';try{const n=await this.enviarDatos({accion:"obtener_pedidos_repartidor",repartidor:t});if(this.limpiarMensaje(),e.innerHTML="",""===n.length)return void(e.innerHTML='<p style="text-align: center;">No tienes entregas pendientes asignadas.</p>');n.forEach(t=>{const n=document.createElement("div");n.className="entrega-item",n.innerHTML=`\n <p><strong>N¬∫ Factura:</strong> ${t.idPedido}</p>\n <p><strong>Cliente:</strong> ${t.cliente}</p>\n <p><strong>Status:</strong> <span class="status-tag status-${t.status.replace(/\s+/g,".")}">${t.status}</span></p>\n `,e.appendChild(n)})}catch(t){this.mostrarMensaje(`Error al obtener la lista: ${t.message}`,"error"),e.innerHTML='<p style="text-align: center; color: red;">No se pudo cargar la lista.</p>'}}
        }
        document.addEventListener('DOMContentLoaded', () => {
            window.sistemaTrazabilidad = new SistemaTrazabilidad();
        });
    </script>
</body>
</html>
