<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Trazabilidad</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f9; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #444; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0;}
        button { display: block; width: 100%; padding: 15px; font-size: 18px; font-weight: bold; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        .btn-main { background-color: #007bff; }
        .btn-secondary { background-color: #6c757d; }
        .btn-confirm { background-color: #28a745; }
        .btn-cancel { background-color: #dc3545; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-size: 16px; }
        #lector-container { position: relative; width: 100%; padding-top: 75%; border: 2px solid #ccc; border-radius: 8px; overflow: hidden; margin-top: 20px; }
        #lector-qr { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .hidden { display: none; }
        #status-message { text-align: center; margin-top: 20px; font-weight: bold; padding: 10px; border-radius: 5px; }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        #confirmacion-datos { border: 2px solid #007bff; padding: 15px; border-radius: 8px; margin-top: 20px; }
        #confirmacion-datos p { margin: 5px 0; font-size: 16px; }
    </style>
</head>
<body>

    <div class="container">
        <div id="vista-principal">
            <h1>Sistema de Trazabilidad</h1>
            <button type="button" id="btn-rol-almacen" class="btn-main">üì¶ M√≥dulo de Almac√©n</button>
            <button type="button" id="btn-rol-repartidor" class="btn-secondary">üöö M√≥dulo de Reparto</button>
        </div>

        <div id="vista-almacen" class="hidden">
            <h2>M√≥dulo de Almac√©n</h2>
            <div id="form-almacen">
                <label for="numero-pedido">N√∫mero de Pedido Original:</label>
                <input type="text" id="numero-pedido" placeholder="Ej: P-801">
                <label for="nombre-surtidor-almacen">Tu Nombre:</label>
                <input type="text" id="nombre-surtidor-almacen" placeholder="Escribe tu nombre">
                <button type="button" id="btn-escanear-factura" class="btn-main">üì∏ Escanear Factura</button>
            </div>
            <div id="confirmacion-datos" class="hidden">
                <h3>Verifica los Datos</h3>
                <p><strong>Cliente:</strong> <span id="conf-cliente"></span></p>
                <p><strong>RFC:</strong> <span id="conf-rfc"></span></p>
                <p><strong>Direcci√≥n:</strong> <span id="conf-direccion"></span></p>
                <p><strong>N¬∫ Pedido:</strong> <span id="conf-pedido"></span></p>
                <p><strong>Folio Fiscal:</strong> <span id="conf-folio"></span></p>
                <button type="button" id="btn-confirmar-registro" class="btn-confirm">‚úÖ Confirmar y Registrar</button>
                <button type="button" id="btn-cancelar-registro" class="btn-cancel">‚ùå Cancelar</button>
            </div>
            <button type="button" id="btn-volver-almacen" class="btn-secondary">Volver al Inicio</button>
        </div>

        <div id="vista-repartidor" class="hidden">
            <h2>M√≥dulo de Reparto</h2>
             <label for="nombre-repartidor">Tu Nombre (Repartidor):</label>
            <input type="text" id="nombre-repartidor" placeholder="Escribe tu nombre">
            <button type="button" id="btn-escanear-transito" class="btn-main">üöö Escanear para "En Tr√°nsito"</button>
            <button type="button" id="btn-escanear-entregado" class="btn-secondary">‚úÖ Escanear para "Entregado"</button>
            <button type="button" id="btn-volver-repartidor" class="btn-secondary">Volver al Inicio</button>
        </div>
        
        <div id="lector-container" class="hidden">
            <video id="lector-qr"></video>
        </div>
        <div id="status-message"></div>
    </div>

    <script type="module">
        import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.min.js";

        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyAqMuAU0vtAccSTTqpcnXpGQkr_xv3O2lNNHmwXH4xIVTwcncZXxk044eRp64TOgD0g/exec";
        
        let modoActual = null;
        let qrScannerInstance;
        let datosPendientes = {};

        const vistas = {
            principal: document.getElementById('vista-principal'),
            almacen: document.getElementById('vista-almacen'),
            repartidor: document.getElementById('vista-repartidor'),
            lector: document.getElementById('lector-container'),
            confirmacion: document.getElementById('confirmacion-datos'),
            formAlmacen: document.getElementById('form-almacen'),
        };
        const statusMessage = document.getElementById('status-message');
        const videoElement = document.getElementById('lector-qr');

        // Navegaci√≥n
        document.getElementById('btn-rol-almacen').addEventListener('click', () => cambiarVista('almacen'));
        document.getElementById('btn-rol-repartidor').addEventListener('click', () => cambiarVista('repartidor'));
        document.getElementById('btn-volver-almacen').addEventListener('click', () => location.reload());
        document.getElementById('btn-volver-repartidor').addEventListener('click', () => location.reload());
        document.getElementById('btn-cancelar-registro').addEventListener('click', () => location.reload());

        function cambiarVista(vista) {
            Object.values(vistas).forEach(v => v.classList.add('hidden'));
            if (vistas[vista]) vistas[vista].classList.remove('hidden');
            if (vista === 'almacen') vistas.formAlmacen.classList.remove('hidden');
        }
        
        function iniciarScanner(modo) {
            modoActual = modo;
            vistas.almacen.classList.add('hidden');
            vistas.repartidor.classList.add('hidden');
            vistas.lector.classList.remove('hidden');
            qrScannerInstance = new QrScanner(videoElement, result => onScanSuccess(result.data), { highlightScanRegion: true });
            qrScannerInstance.start().catch(err => mostrarMensaje(`Error al iniciar c√°mara: ${err}`, 'error'));
        }
        
        function detenerScanner() {
            if (qrScannerInstance) { qrScannerInstance.stop(); qrScannerInstance.destroy(); }
            vistas.lector.classList.add('hidden');
        }
        
        async function onScanSuccess(decodedText) {
            detenerScanner();
            mostrarMensaje("Procesando QR...", "");
            try {
                const url = new URL(decodedText);
                const urlParams = new URLSearchParams(url.search);
                const idPedido = urlParams.get('id');
                const rfc = urlParams.get('rr');
                if (!idPedido) throw new Error("El QR no parece ser una factura v√°lida.");

                if (modoActual === 'registrar') {
                    const numeroPedido = document.getElementById('numero-pedido').value;
                    const surtidor = document.getElementById('nombre-surtidor-almacen').value;
                    if (!numeroPedido.trim() || !surtidor.trim()) throw new Error("Rellena el n√∫mero de pedido y tu nombre.");
                    
                    datosPendientes = { numeroPedido, surtidor, idPedido, rfc };
                    await enviarDatosAlScript({ accion: 'validar_factura', rfc });
                } else {
                    const usuario = document.getElementById('nombre-repartidor').value;
                    if(!usuario.trim()) throw new Error("Rellena tu nombre de repartidor.");
                    const payload = { accion: 'actualizar_status', idPedido, nuevoStatus: modoActual, usuario };
                    if (modoActual === 'Entregado') payload.ubicacion = await obtenerUbicacion();
                    await enviarDatosAlScript(payload);
                }
            } catch (error) {
                mostrarMensaje(`Error: ${error.message}`, 'error');
                setTimeout(() => location.reload(), 4000);
            }
        }

        document.getElementById('btn-confirmar-registro').addEventListener('click', async () => {
            const payload = {
                accion: 'registrar_factura',
                idPedido: datosPendientes.idPedido,
                rfc: datosPendientes.rfc,
                numeroPedidoOrigen: datosPendientes.numeroPedido,
                surtidor: datosPendientes.surtidor,
                razonSocial: document.getElementById('conf-cliente').textContent
            };
            await enviarDatosAlScript(payload);
        });

        function mostrarPantallaConfirmacion(cliente) {
            cambiarVista('almacen');
            vistas.formAlmacen.classList.add('hidden');
            vistas.confirmacion.classList.remove('hidden');
            document.getElementById('conf-cliente').textContent = cliente['Raz√≥n Social'] || 'N/A';
            document.getElementById('conf-rfc').textContent = cliente.RFC || 'N/A';
            document.getElementById('conf-direccion').textContent = `${cliente.Calle || ''} ${cliente['Num ext.'] || ''}, ${cliente.Colonia || ''}`.trim();
            document.getElementById('conf-pedido').textContent = datosPendientes.numeroPedido;
            document.getElementById('conf-folio').textContent = datosPendientes.idPedido.substring(0, 8) + '...';
        }
        
        async function enviarDatosAlScript(payload) {
            mostrarMensaje("Enviando datos...", "");
            const urlConDatos = new URL(SCRIPT_URL);
            urlConDatos.searchParams.append('data', JSON.stringify(payload));
            try {
                const response = await fetch(urlConDatos, { method: 'GET' });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);

                if (payload.accion === 'validar_factura') {
                    mostrarPantallaConfirmacion(result.data);
                } else {
                    mostrarMensaje(result.data, 'success');
                    setTimeout(() => location.reload(), 4000);
                }
            } catch (error) {
                mostrarMensaje(`Error de comunicaci√≥n: ${error.message}`, 'error');
                console.error("Error en Fetch:", error);
                 setTimeout(() => location.reload(), 4000);
            }
        }

        function obtenerUbicacion() {
            return new Promise(resolve => {
                if (!navigator.geolocation) return resolve("Geolocalizaci√≥n no soportada");
                navigator.geolocation.getCurrentPosition(
                    p => resolve(`http://googleusercontent.com/maps.google.com/9{p.coords.latitude},${p.coords.longitude}`),
                    () => resolve("No se pudo obtener la ubicaci√≥n"), { timeout: 10000 }
                );
            });
        }

        function mostrarMensaje(mensaje, tipo) {
            statusMessage.textContent = mensaje;
            statusMessage.className = `status-${tipo}`;
        }
        
        document.getElementById('btn-escanear-factura').addEventListener('click', () => iniciarScanner('registrar'));
        document.getElementById('btn-escanear-transito').addEventListener('click', () => iniciarScanner('En Tr√°nsito'));
        document.getElementById('btn-escanear-entregado').addEventListener('click', () => iniciarScanner('Entregado'));
    </script>
</body>
</html>
